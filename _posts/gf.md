title: 小小的GoldFish，小小的简介
date: 2016-2-29 22:11:40
tags: [goldfish,程序猿]
categories: 杂项
---
# 小小的GoldFish，小小的简介


---

&emsp;&emsp;GoldFish是一个简单的分布式内存数据库，从14年后半段开始，调研加设计历时将近一年。师兄们实现了一部分，我们修补，然后又设计和实现了执行引擎，到现在又花了将近一年的时间。一月末跑通了第一条SQL语句并在模拟的客户端显示了结果，总算打通了整个系统。这算是一个里程碑式的事件。目前对SQL语句的支持是不完整的，系统Debug+调优的路还很长。它实验的性质偏多，但是至少在工程方面让我自己有了实战的经验，并且遇到了和尝试解决中间遇到的各种问题。
***
## 架构简介
![架构图](/images/gf.jpg)

* Portal：模拟客户端
* DM：主控节点，主要负责域管理，用户管理以及相关的权限管理
* DC：域，一个域包含多个MDE和DIS，域与域之间数据隔离，控制着用户真实的操作权限（导入、查询），接收用户发来的请求，并分配资源和执行
* DIS：包括RA和DS两个模块，负责数据的并行导入，设计时考虑过oracle、mysql等多种数据库源，现在我们在测试中主要使用的是oracle。
 * RA：负责从真正的数据库中获得数据库相关元数据，在接收到导入指令后从数据库中快速的导出数据
 * DS：从数据库中获得的原始数据在这里进行排序、计算，形成我们所需要的数据结构（Groupkey）
* MDE：存储引擎加上查询引擎统称
 * CS：内存数据存储引擎
 * QE：查询引擎

&emsp;&emsp;GF主要面对的场景是读多写少OLAP的场景（目前还没有设计写），几个主要部分的功能都在上面了。除此之外，我们还曾经设计过一个名为RAS的资源管理模块，遗憾的是鉴于人手的原因，一直未被真正的实现，目前对资源（DS，CS，QE均为一种资源）的调度，由DC暂为代管，采用轮转调度算法。麻雀虽小，却也五官俱全，我也仅仅是在某一刻在内心这么认为。尽管目前我们同样规模的集群和数据，同样的sql语句，比spark出色一些，但是在优化的路上，却逐渐的发现，整个系统少了一些灵魂。在一条sql语句的情况下，大量计算大批量数据传输的时候，我们算子任务分布（我们称为任务DAG）一开始采用一种简单粗暴的策略——数据本地、计算本地，某些sql语句生成任务DAG后，大量的任务在同一台节点上，资源使用不合理。
&emsp;&emsp;此刻在回头来，才发现我们的系统没有事务、没有物理资源调度、没有代价模型计算较优DAG分布、没有针对数据分布策略进行系统的研究、也没有像spark那样的计算数据cache加速查询，这其中的每一项问题都是非常有意思的，也是分布式数据库最核心的几样东西。对这些问题的研究需要更多的精力和时间。但是我们的架子渐渐稳定，以Groupkey为基石已经进行了对数据库表的横切、纵切，并且以它为核心的数据（原始数据/算计计算出来的中间数据）序列化、反序列化、基本算子（join、getcolumn、buildrow）都已经实现了，并且还有着不错的表现，这是非常值得我们项目组骄傲的。随着优化的进行，我们在细节上的水分被压榨了出来，现在估计这周完，便走到了必须要进行大局上的大优化了——那就是任务代价模型。毕竟细节上提升性能1%级别的，那调度上的优化那就是10%级别的。

---

## 存储基石

&emsp;&emsp;我们的存储模型Groupley来源当时师兄们对sap hana的调研。记不太清楚当时是hana官方给出的文档还是从某个从hana离职工程师发出的paper上获得的。其实挺好理解的，把一个列数据化为了三个向量，三个向量分别叫dic，index，position。（起始偏移量直接理解成vector[x]中的x）第一个向量记录了字典真实的值，第二个向量记录的是同偏移量的字典对应的position向量的起始偏移量，position中存储的是真实的row id，既行id。看一下图自己推敲一下便可。某列重复很多的时候，这种数据结构可以很好的压缩数据。
![groupkey](/images/groupkey.jpg)
